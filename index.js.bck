require('dotenv').config();
const { Client, GatewayIntentBits } = require('discord.js');
const axios = require('axios');

// ConfiguraÃ§Ã£o do cliente Discord com as intents necessÃ¡rias
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

// Evento disparado quando o bot estÃ¡ pronto
client.on('ready', () => {
  console.log(`ðŸ¤– Bot conectado como ${client.user.tag}`);
  console.log(`ðŸ” Monitorando mensagens no canal: grow-a-garden-stock`);
});

// Comando de teste para verificar se o bot estÃ¡ respondendo
client.on('messageCreate', async (message) => {
  // Log de todas as mensagens para depuraÃ§Ã£o
  console.log(`ðŸ“¨ Mensagem detectada no canal: ${message.channel.name} de: ${message.author.username}`);
  
  // Comando de teste simples
  if (message.content === '!teste') {
    message.channel.send('Bot funcionando!');
    console.log('âœ… Comando de teste respondido!');
    return;
  }

  // Tratamento de mensagens de bots
  if (message.author.bot) {
    if (message.author.id === '929212048726650950') {
      console.log(`ðŸ¤– Mensagem do bot Arcaiuz detectada!`);
    } else {
      console.log(`â­ï¸ Ignorando mensagem do bot: ${message.author.username}`);
      return;
    }
  }

  // VerificaÃ§Ã£o do canal correto
  if (message.channel.name === 'grow-a-garden-stock') {
    console.log(`âœ… Mensagem no canal correto!`);
    console.log(`ðŸ“ ConteÃºdo: ${message.content.substring(0, 50)}...`);
    
    try {
      console.log(`ðŸ”„ Tentando enviar para webhook: ${process.env.N8N_WEBHOOK_URL}`);
      
      const payload = {
        content: message.content,
        timestamp: message.createdAt,
        author: message.author.username,
        channel: message.channel.name
      };
      
      console.log(`ðŸ“¦ Payload: ${JSON.stringify(payload)}`);
      
      const response = await axios.post(process.env.N8N_WEBHOOK_URL, payload, {
        timeout: 10000, // 10 segundos de timeout
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      console.log(`ðŸ“¤ Mensagem enviada para o n8n com status: ${response.status}`);
    } catch (err) {
      console.error(`âŒ Erro ao enviar para o n8n: ${err.message}`);
      if (err.response) {
        console.error(`ðŸ“‹ Detalhes do erro: ${JSON.stringify(err.response.data)}`);
      }
    }
  } else {
    console.log(`âŒ Mensagem em canal diferente: ${message.channel.name}`);
  }
});

// Tratamento de erros para evitar que o bot caia
client.on('error', (error) => {
  console.error(`ðŸ”´ Erro no cliente Discord: ${error.message}`);
});

process.on('unhandledRejection', (error) => {
  console.error(`ðŸ”´ Erro nÃ£o tratado: ${error.message}`);
});

// Login do bot
console.log('ðŸ”‘ Tentando conectar com o token fornecido...');
client.login(process.env.TOKEN_DISCORD)
  .catch(error => {
    console.error(`ðŸ”´ Erro ao fazer login: ${error.message}`);
  });